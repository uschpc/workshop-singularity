<!DOCTYPE html>
<html>
  <head>
    <title>Software Containers with Singularity</title>
    <meta charset="utf-8">
    <meta name="author" content="Center for Advanced Research Computing at University of Southern California" />
    <link rel="stylesheet" href="main.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">

class: left, top, title-slide

# Software Containers with Singularity

### Center for Advanced Research Computing <br> University of Southern California <br>

### Last updated on 2022-09-23

---

## Outline

1. Overview of software containers
2. Getting pre-built container images
3. Building custom container images
4. Running containers

---

## What is a software container?

- A software environment that bundles a main application and all its dependencies
- OS-level virtualization with process-level isolation on host system
- Provides a custom user space separate from host system
- Different from a virtual machine
  - Containers have direct access to the host kernel
  - Virtual machines have indirect access (performance penalty)

---

## Container architecture

<img src="singularity-architecture.png" height="450" />

Source: [Singularity Community and SingularityPRO on high-performance servers](https://sylabs.io/download/singularity-community-and-singularitypro-on-high-performance-servers/)

---

## What do containers enable?

- A software environment that is:
  - Shareable
  - Portable
  - Stable
  - Reproducible
  - Isolated
  - Secure

---

## Some terminology

- **Container image** &mdash; executable file saved on disk (immutable blueprint)
- **Container** &mdash; running instance of a container image
- **Container engine** &mdash; application that builds and runs container images
- **Host system** &mdash; system that runs the container engine
- **Container registry** &mdash; catalog of container images

---

## Diverse container ecosystem

- Container image formats
  - Docker, LXD, etc.
  - Singularity
- Container engines
  - Docker, LXC, etc.
  - Singularity
- Container registries
  - Docker Hub, Quay, etc.
  - Singularity Cloud Library
- Open Container Initiative (OCI) for interoperability
  - Image format standard
  - Runtime standard
  - Distribution standard

---

## Docker vs. Singularity

- Docker
  - Designed for running persistent services (e.g., web apps)
  - Requires superuser privileges to run container images
- Singularity
  - Designed for running HPC workloads
  - Does not require superuser privileges to run container images
- Superuser privileges restricted to system admins on shared HPC systems
- Both adhere to OCI image format standard
  - Can convert images from Docker to Singularity format
  - Or vice versa: [singularity2docker.sh](https://github.com/singularityhub/singularity2docker)

---

## Singularity containers

- A container engine designed for HPC and shared HPC systems running Linux
- Originally developed at LBNL (spinoff firm Sylabs with open-core model)
- Can be fully isolated from or integrated with host system
  - Defaults to integration
  - Useful for parallel file systems, GPUs, high-speed networks
- 2021 split in developer community
  - SingularityCE (from Sylabs)
  - Apptainer (project within Linux Foundation)
- Most popular container engine for HPC
- Alternatives for HPC
  - Sarus
  - Charliecloud
  - Shifter

---

## Why use Singularity for research computing?

- Install anything you want (based on any Linux OS)
- Ease installation issues by using pre-built container images
- If developer, bundle complex software stacks for easier distribution
- Convert Docker images to Singularity images to run on HPC systems
- Ensure reproducible software environments
- Ensure the same software stack is used among a research group
- Ensure the same software stack is used across Linux systems (e.g., any HPC center)
- Use older or development versions of software (not available in modules)
- Use proprietary software (typically distributed as binaries) that depends on other software not available on host system

---

## Some limitations of Singularity

- Built for Linux systems
- Portability depends on a few factors
  - CPU architecture format (x86 vs. ARM)
  - Binary format (ELF)
  - Kernel, glibc, other API compatibility
- Not always backward compatible (v2 vs. v3)
- Need superuser privileges to build images
- No build layer caches

---

## Singularity container image format

- A single immutable, compressed, executable image file (`.sif`)
- If you need to modify an image, you have to rebuild it or use as base image
- Adheres to OCI image format standard

---

## Getting and running images

- Getting images
  - Pull pre-existing images from container registries
  - Download images from software websites
  - Build your own custom image
- Running images
  - Run images in interactive or batch modes
  - Various options can be used to isolate/integrate with host system

---

## Pulling existing container images

- Pull from container registries
- [Singularity Cloud Library](https://cloud.sylabs.io/library)

```bash
singularity pull library://ubuntu:latest
```

- [Docker Hub](https://hub.docker.com/)

```bash
singularity pull docker://clearlinux:latest
```

---

## Building custom images externally

- Need to build outside of CARC systems (requires superuser privileges)
- But need a Linux OS
- Can build interactively in a sandbox mode (keep track of commands)
- Better to build in batch mode with a definition file (reproducible recipe)
- Best approach is to use the cloud-based [Singularity Remote Builder](https://cloud.sylabs.io/builder)
- Or use a virtual machine on your local computer (e.g., [Multipass](https://multipass.run/), [Virtual Box](https://www.virtualbox.org/))
- Alternatively, create a Docker container image locally, upload to Docker Hub, and then pull

---

## Building workflow

1. Create a definition file
2. Build image externally using the definition file
3. If error occurs, modify definition file and rebuild (back to step 1)
4. Transfer image file to CARC systems
5. Test image
6. If error occurs, modify definition file and rebuild (back to step 1)

---

## Definition files

- Recipe for building a container image
  - Start with a base Linux OS (e.g., Debian, Ubuntu, CentOS, Rocky Linux, Clear Linux)
  - Or start with existing container image from a registry
  - Then install software, add files, etc.
- Similar to a Dockerfile, but different syntax
- [CARC Singularity template definition files](https://github.com/uschpc/singularities)

---

## Structure of a definition file

```bash
# Header (required)
Bootstrap: ...
From: ...
# Sections (optional)
%files
    Copy files to the container from host (/source /destination)
%post
    Install software and libraries, write configuration files, etc.
%test
    Run commands to validate build process
%environment
    Define environment variables that will be set at runtime
%startscript
    Run commands when singularity instance start command is used
%runscript
    Run commands when singularity run command is used    
%labels
    Add metadata labels (name-value pair)
%help
    Describe the container and its intended use
```

---

## Example definition file

```bash
Bootstrap: docker
From: clearlinux/r-base:latest

%post
    swupd update --quiet
    swupd bundle-add --quiet R-stan
    swupd clean --all

%test
    R --version

%environment
    export LC_ALL=C

%runscript
    R

%help
    Clear Linux with latest version of R linked to OpenBLAS and rstan package installed.
```

---

## Using Singularity Remote Builder

- [Singularity Container Services](https://cloud.sylabs.io) by [Sylabs](https://www.sylabs.io)
- Free service with up to 11 GB of storage
- Log in with other account (GitHub, GitLab, Google, Microsoft)
- Set up [access token](https://cloud.sylabs.io/tokens) on CARC systems 
- Use web interface to build
- Or build remotely from the command line

```bash
singularity build --remote rstan.sif rstan.def
```

---

## Installing optimized software

- Tradeoff between portability and performance
- Choice of base OS for an image can be important for performance
- Using Linux package managers (e.g., APT, DNF) typically downloads generic binaries
- APT provides [apt-build](https://manpages.debian.org/bullseye/apt-build/apt-build.1.en.html) to build packages from source with CPU architecture optimizations
- Clear Linux swupd package manager provides optimized builds for Intel CPU architectures (limited software choices)
- [Spack](https://spack.readthedocs.io/en/latest/index.html) can be used to build and [containerize](https://spack.readthedocs.io/en/latest/containers.html) optimized software stacks

---

## Multi-stage builds

- Singularity also supports [multi-stage builds](https://sylabs.io/guides/latest/user-guide/definition_files.html#multi-stage-builds)
- Primary use case is to minimize final image size
- Build main application in the first stage (requiring build-time dependencies)
- Copy compiled binary to a clean environment in the second stage (requiring run-time dependencies)
- So final image does not contain unneeded build tools


---

## Inspecting container images

```bash
singularity inspect --deffile rstan.sif

singularity inspect --environment rstan.sif

singularity inspect --runscript rstan.sif
```

---

## Running containers

- A container process is like any other Linux process
- Just a different software environment
- Three commands:
  - `singularity shell` &mdash; for an interactive shell within the container
  - `singularity exec` &mdash; for executing commands within the container
  - `singularity run` &mdash; for running a pre-defined runscript within the container

---

## Examples

```bash
singularity shell rstan.sif

singularity exec rstan.sif Rscript -e 'print("Hello world")'

singularity run rstan.sif
```

---

## Filesystem within containers

- Unique filesystem within a container
  - `/bin`
  - `/lib`
  - `/usr`
- Some directories from the host system are automatically mounted to the container
  - `/home1/<username>`
  - `/tmp`
  - `/var/tmp`
  - `/proc`
  - `/sys`
  - `/dev`

---

## Bind mounting directories to containers

- Use the `--bind` option to mount files or directories
- For example, to add your current working directory and `/scratch1` directory:

```bash
singularity exec --bind $PWD,/scratch1/<username> rstan.sif Rscript script.R
```

- Can also change name when binding if needed:

```bash
singularity exec --bind $PWD:/mydir rstan.sif Rscript script.R
```

---

## Other useful options

- Often a good idea to use `--cleanenv` (or shorter `-e`)
- May need to use `--no-home` to exclude `/home1` directory
  - e.g., for Python or R containers
  - Packages are installed in your home directory by default
  - Can lead to conflicts with software installed in container

```bash
singularity exec --no-home --bind $PWD rstan.sif Rscript script.R
```

- Use `--containall` for maximum isolation from host system

---

## Running containers on GPUs

- Containers need to access host GPU driver
- Use `--nv` option to access Nvidia GPUs
- Run `nvidia-smi` on Nvidia GPU node to see current driver version and compatibility
- Use `--rocm` option to access AMD ROCm GPUs (none on CARC systems)
- [GPU support docs](https://sylabs.io/guides/latest/user-guide/gpu.html)
- Example for a TensorFlow runscript using Nvidia GPU:

```bash
singularity run --cleanenv --nv tf.sif
```

---

## Running containers with MPI

- Two approaches: hybrid vs. mount
- Pros and cons for each approach
- Less portable because it depends on MPI versions available on host system
- [MPI support docs](https://sylabs.io/guides/latest/user-guide/mpi.html)
- Example for an OpenMPI program:

```bash
srun --mpi=pmix_v2 -n $SLURM_NTASKS singularity exec openmpi.sif ./mpi_program
```

---

## Singularity environment variables

- Some useful environment variables can be set
- Add to `~/.bashrc` to automatically set every time you log in
- For example, change cache directory from `/home1` to `/scratch1`:

```bash
export SINGULARITY_CACHEDIR=/scratch1/<username>/.singularity
```

- For example, add certain bind paths to every container:

```bash
export SINGULARITY_BIND=/scratch1/<username>,/project/<project_id>
```

---

## Example Slurm job script

```bash
#!/bin/bash

#SBATCH --account=<project_id>
#SBATCH --partition=main
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=16GB
#SBATCH --time=1:00:00

module purge

singularity exec --cleanenv --no-home --bind $PWD rstan.sif Rscript script.R
```

---

## Singularity documentation

- [Official docs](https://sylabs.io/guides/latest/user-guide/)  

```bash
singularity help

singularity help shell

singularity help exec

singularity help run
```

---

## Additional resources

- [Singularity website](https://sylabs.io/singularity)
- [Singularity documentation](https://sylabs.io/guides/master/user-guide/)
- [Singularity tutorial](https://singularity-tutorial.github.io/)
- [Singularity Remote Builder](https://cloud.sylabs.io/builder)
- [Singularity Cloud Library](https://cloud.sylabs.io/library)
- [Docker Hub](https://hub.docker.com/)
- [BioContainers](https://biocontainers.pro)
- [Dockstore](https://www.dockstore.org/)
- [Intel oneContainer Portal](https://www.intel.com/content/www/us/en/developer/tools/containers/overview.html)
- [NVIDIA GPU Cloud Catalog](https://ngc.nvidia.com/catalog)

---

## CARC support

- [Using Singularity on CARC Systems](https://www.carc.usc.edu/user-information/user-guides/software-and-programming/singularity)
- [CARC Singularity template definition files](https://github.com/uschpc/singularities)
- [Submit a support ticket](https://www.carc.usc.edu/user-information/ticket-submission)
- [User Forum](https://hpc-discourse.usc.edu/)
- Office Hours
  - Every Tuesday 2:30-5pm
  - Get Zoom link [here](https://www.carc.usc.edu/education-and-resources/office-hours)

---

## Exercises

- Pull a container image from a registry
- Build a custom container image
    - Create a definition file
    - Use the Remote Builder to build the custom image
    - Transfer the image to CARC systems
- Inspect a container image
- Bind mount a `/project` directory to a container and list its files
- Run a script or program through a container

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: "16:10",
        highlightStyle: "ascetic",
      });
    </script>
  </body>
</html>
